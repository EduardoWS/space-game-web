<!doctype html>
<html>

<head>
  <title>Space Game</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta id="gameViewport" name="viewport" content="width=device-width initial-scale=1">
  <link href="styles.css?v=1.2" rel="stylesheet" type="text/css">
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>

  <!-- Game Container -->
  <div align="center" id="embed-html"></div>

  <!-- Game Logic -->
  <script>
    // 1. Firebase Logic
    const firebaseConfig = {
      apiKey: "AIzaSyDvraBN9ZbLDS8rGpOHTpNlS56rDKkrBp0",
      authDomain: "space-game-web.firebaseapp.com",
      projectId: "space-game-web",
      storageBucket: "space-game-web.firebasestorage.app",
      messagingSenderId: "558062429284",
      appId: "1:558062429284:web:51c0748573ec10359cab71"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;

    // Globals for GWT
    window.spaceGameUsername = null;
    window.spaceGameEmail = null;
    window.spaceGameUid = null;
    window.spaceGameSettings = { music: 0.25, sound: 0.5 };

    // Auth Check
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not logged in? Redirect to Launcher
        window.location.href = "/";
        return;
      }
      currentUser = user;
      window.spaceGameUid = user.uid;
      window.spaceGameEmail = user.email;

      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          window.spaceGameUsername = data.username;
          if (data.settings) window.spaceGameSettings = data.settings;
        }
        // Load Game Script
        loadGame();
      } catch (e) {
        console.error("Error loading profile:", e);
        // Load anyway?
        loadGame();
      }
    });

    function loadGame() {
      if (!document.getElementById('gwt-script')) {
        const script = document.createElement('script');
        script.id = 'gwt-script';
        script.type = 'text/javascript';
        script.src = 'html/html.nocache.js';
        document.body.appendChild(script);
      }
    }

    // JSNI Bridging
    window.saveSettingsJS = function (musicVol, soundVol) {
      window.spaceGameSettings = { music: musicVol, sound: soundVol };
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({
          settings: window.spaceGameSettings
        }).catch(e => console.error("Error saving settings:", e));
      }
    };
    window.exitToLauncherJS = function () {
      window.location.href = "/";
    };
    window.getSettingsJS = function () {
      return JSON.stringify(window.spaceGameSettings);
    };

    // Global Scores
    window.getGlobalScoresJS = async function (callback) {
      try {
        const snapshot = await db.collection('users')
          .orderBy('highScore', 'desc')
          .limit(10)
          .get();

        let scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.highScore) {
            scores.push({
              username: data.username,
              highScore: data.highScore
            });
          }
        });
        callback(JSON.stringify(scores));
      } catch (e) {
        callback("[]");
      }
    };

    // Save Score
    window.saveScoreJS = async function (username, score) {
      if (!currentUser) return;
      try {
        const userRef = db.collection('users').doc(currentUser.uid);
        await db.runTransaction(async (transaction) => {
          const userDoc = await transaction.get(userRef);
          if (!userDoc.exists) return; // Should not happen

          const currentBest = userDoc.data().highScore || 0;
          if (score > currentBest) {
            transaction.update(userRef, { highScore: score });
          }
        });
      } catch (e) { console.error(e); }
    }

    window.checkBackendJS = function (callback) {
      // Simple ping or immediate Callback
      callback();
    };


    // Prevent Context Menu
    document.addEventListener('contextmenu', event => event.preventDefault());
    function handleMouseDown(evt) { evt.preventDefault(); evt.stopPropagation(); window.focus(); }
    function handleMouseUp(evt) { evt.preventDefault(); evt.stopPropagation(); }
    const c = document.getElementById('embed-html');
    if (c) {
      c.addEventListener('mousedown', handleMouseDown, false);
      c.addEventListener('mouseup', handleMouseUp, false);
    }
  </script>
</body>

</html>