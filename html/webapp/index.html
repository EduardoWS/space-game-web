<!doctype html>
<html>

<head>
  <title>Space Game</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta id="gameViewport" name="viewport" content="width=device-width initial-scale=1">
  <link href="styles.css?v=1.2" rel="stylesheet" type="text/css">
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>

  <!-- Game Container -->
  <div align="center" id="embed-html"></div>

  <!-- Game Logic -->
  <script>
    // 1. Firebase Logic
    const firebaseConfig = {
      apiKey: "AIzaSyDvraBN9ZbLDS8rGpOHTpNlS56rDKkrBp0",
      authDomain: "space-game-web.firebaseapp.com",
      projectId: "space-game-web",
      storageBucket: "space-game-web.firebasestorage.app",
      messagingSenderId: "558062429284",
      appId: "1:558062429284:web:51c0748573ec10359cab71"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;

    // Globals for GWT
    window.spaceGameUsername = null;
    window.spaceGameEmail = null;
    window.spaceGameUid = null;
    window.spaceGameSettings = { music: 0.25, sound: 0.5 };

    // Auth Check
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not logged in? Redirect to Launcher
        window.location.href = "/";
        return;
      }
      currentUser = user;
      window.spaceGameUid = user.uid;
      window.spaceGameEmail = user.email;

      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          window.spaceGameUsername = data.username;
          if (data.settings) window.spaceGameSettings = data.settings;
        }
        // Load Game Script
        loadGame();
      } catch (e) {
        console.error("Error loading profile:", e);
        // Load anyway?
        loadGame();
      }
    });

    function loadGame() {
      if (!document.getElementById('gwt-script')) {
        const script = document.createElement('script');
        script.id = 'gwt-script';
        script.type = 'text/javascript';
        script.src = 'html/html.nocache.js';
        document.body.appendChild(script);
      }
    }

    // JSNI Bridging
    window.saveSettingsJS = function (musicVol, soundVol) {
      window.spaceGameSettings = { music: musicVol, sound: soundVol };
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({
          settings: window.spaceGameSettings
        }).catch(e => console.error("Error saving settings:", e));
      }
    };
    window.exitToLauncherJS = function () {
      window.location.href = "/";
    };
    window.getSettingsJS = function () {
      return JSON.stringify(window.spaceGameSettings);
    };

    // Global Scores - Fetch from 'scores' collection
    window.getGlobalScoresJS = async function (callback) {
      try {
        const snapshot = await db.collection('scores')
          .orderBy('score', 'desc')
          .limit(10)
          .get();

        let scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          scores.push({
            username: data.playerName || "Unknown",
            highScore: data.score || 0
          });
        });
        callback(JSON.stringify(scores));
      } catch (e) {
        console.error("Error fetching scores:", e);
        callback("[]");
      }
    };

    // Save Score - Global Scores Top 10 Only
    window.saveScoreJS = async function (username, score) {
      if (!currentUser) return;
      const uid = currentUser.uid;
      const gameUsername = window.spaceGameUsername || username || "Pilot";

      try {
        // Update Global Leaderboard in 'scores' collection (Top 10 only)
        // Check if user is already in leaderboard
        const userScoreQuery = await db.collection('scores').where('uid', '==', uid).limit(1).get();

        if (!userScoreQuery.empty) {
          // User is already on the board, update if higher
          const doc = userScoreQuery.docs[0];
          if (score > doc.data().score) {
            await doc.ref.update({
              score: score,
              playerName: gameUsername,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        } else {
          // User not on board. Just Add.
          // Cloud Function 'maintainLeaderboard' will handle removing excess scores (Top 10).
          await db.collection('scores').add({
            uid: uid,
            playerName: gameUsername,
            score: score,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

      } catch (e) {
        console.error("Error saving score:", e);
      }
    }

    window.checkBackendJS = function (callback) {
      callback();
    };


    // Prevent Context Menu
    document.addEventListener('contextmenu', event => event.preventDefault());
    function handleMouseDown(evt) { evt.preventDefault(); evt.stopPropagation(); window.focus(); }
    function handleMouseUp(evt) { evt.preventDefault(); evt.stopPropagation(); }
    const c = document.getElementById('embed-html');
    if (c) {
      c.addEventListener('mousedown', handleMouseDown, false);
      c.addEventListener('mouseup', handleMouseUp, false);
    }
  </script>
</body>

</html>